
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/anime.css') }}">
    </head>
<body class="anime-page">
    <div class="anime-wrap">
        <header class="anime-header">
            <div>
                <div class="anime-brand">Logging Studio</div>
                <div class="anime-sub">Live requests — Attacker is following you</div>
            </div>
            <div class="anime-actions">
                <a href="/payload" class="anime-link">Payload</a>
                <a href="/profile" class="anime-link">Profile</a>
                <a href="/api/logout" class="anime-link">Logout</a>
                <div class="anime-sub">User: <strong>{{ session.get('user') }}</strong></div>
            </div>
        </header>

        <div class="anime-top">
            <div class="info-row">
                <div>URL:</div>
                <strong id="userLink">{{ u_link }}</strong>
                <button id="copyBtn" class="anime-btn">Copy URL</button>
                <span class="anime-sub"></span>
            </div>
        </div>

        <div class="main-grid">
            <aside class="sidebar-card">
                <h3 style="margin:0 0 8px 0;color:var(--accent1)">History</h3>
                <div id="requestList"></div>
            </aside>

            <section>
                <div class="detail-card">
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <h3>Request detail</h3>
                        <button id="copyDetailBtn" class="anime-btn">Copy detail</button>
                    </div>
                    <div style="margin-top:10px">
                        <pre id="detailPre" class="detail-pre">Chọn một request từ danh sách bên trái để xem chi tiết.</pre>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        function copyText(text, button) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopied(button);
                }).catch(err => {
                    console.error("Clipboard API failed", err);
                });
            } else {
                let textarea = document.createElement("textarea");
                textarea.value = text;
                textarea.style.position = "fixed"; 
                textarea.style.opacity = 0; 
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                try {
                    document.execCommand("copy");
                    showCopied(button);
                } catch (err) {
                    console.error("Fallback copy failed", err);
                }
                document.body.removeChild(textarea);
            }
        }

        function showCopied(button) {
            const originalText = button.innerText;
            button.innerText = "Copied!";
            button.disabled = true;
            setTimeout(() => {
                button.innerText = originalText;
                button.disabled = false;
            }, 2000);
        }

        function fetchAndUpdateRequests() {
            fetch("/api/log")
                .then(res => {
                    if (!res.ok) throw new Error("Failed to fetch data");
                    return res.json();
                })
                .then(data => {
                    // sort logs by time (newest first). Use Date.parse fallback to 0 for invalid times.
                    try {
                        data.sort((a, b) => {
                            const ta = Date.parse(a.time) || 0;
                            const tb = Date.parse(b.time) || 0;
                            return tb - ta;
                        });
                    } catch (e) {
                        console.warn('Could not sort logs by time:', e);
                    }
                        const list = document.getElementById("requestList");
                        const detailPre = document.getElementById("detailPre");

                        function renderDetail(req) {
                            const parts = [];
                            parts.push(`ID: ${req.id}`);
                            parts.push(`IP: ${req.client_ip}`);
                            parts.push(`Port: ${req.client_port}`);
                            parts.push(`Time: ${req.time}`);
                            parts.push('');
                            parts.push('--- Header ---');
                            parts.push(req.B || 'N/A');
                            if (req.C) { parts.push(''); parts.push('--- Data ---'); parts.push(req.C); }
                            parts.push('');
                            parts.push('--- Response ---');
                            parts.push(req.F || 'N/A');
                            detailPre.textContent = parts.join('\n');
                        }
                    const currentActive = document.querySelector(".request-item.active");
                    const currentActiveId = currentActive ? currentActive.dataset.id : null;
                    const viewedIds = new Set(
                        Array.from(document.querySelectorAll(".request-item.viewed"))
                            .map(item => item.dataset.id)
                    );

                    list.innerHTML = "";
                    data.forEach((req, idx) => {
                        const item = document.createElement("div");
                        item.className = "request-item";
                        item.dataset.id = req.id;
                        if (viewedIds.has(req.id)) {
                            item.classList.add("viewed");
                        }
                        item.innerHTML = `<strong>${req.client_ip}</strong><br><small>${req.time}</small>`;
                        
                        item.addEventListener("click", () => {
                            document.querySelectorAll(".request-item").forEach(i => i.classList.remove("active"));
                            item.classList.add("active");
                            item.classList.add("viewed");

                            renderDetail(req);
                        });
                        if ((idx === 0 && !currentActiveId) || req.id === currentActiveId) {
                            item.click();
                        }
                        list.appendChild(item);
                    });
                })
                .catch(err => {
                    console.error("Error fetching data:", err);
                    document.getElementById("requestList").innerHTML = "<p>Error loading requests. Please try again later.</p>";
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            fetchAndUpdateRequests();
            setInterval(fetchAndUpdateRequests, 3000);
            document.getElementById("copyBtn").addEventListener("click", function() {
                const link = document.getElementById("userLink").innerText;
                copyText(link, this);
            });
                    const copyDetailBtn = document.getElementById('copyDetailBtn');
                    if (copyDetailBtn) {
                        copyDetailBtn.addEventListener('click', function() {
                            const text = document.getElementById('detailPre').innerText;
                            copyText(text, this);
                        });
                    }
        });
    </script>
</body>
</html>
